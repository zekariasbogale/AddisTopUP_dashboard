<!-- Start web template header maintained by Zekarias Bogale -->

<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Addis TopUP</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">EVD Dashboard</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse">
            <ul class="nav navbar-nav">
                <li><a href="agents.html">Manage Agents</a></li>
                <li><a href="evs.html">Manage EVs</a></li>
                  <ul class="nav navbar-nav">
                      <li><a href="upload_evs.html">Upload EVs</a></li>
                      <li><a href="distribute_evs.html">Distribute EVs</a></li>
                  </ul>
                <li><a href="#">Transactions</a></li>
                <li><a href="#">Activity Log</a></li>
                <li><a href="#">User: root</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div>
</nav>



<div class="container">


    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="panel panel-default">
                <div class="panel-heading"></div>

                <div class="panel-body">

<!-- End web template header maintained by Zekarias Bogale -->

<!-- Upload CSV started by Bire-->

    <form class="form-horizontal well">

        <fieldset>
            <label for="csvFileInput"> <strong>CSV File:</strong>
            </label>
            <input type="file" id="csvFileInput" onchange="handleFiles(this.files)"
                   accept=".csv">

        </fieldset>
    </form>
    <div id="output"></div>
</div>
    <br>
    <br>

<!-- Le javascript
  ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
<script type="text/javascript" src="scripts/script.js"></script>

<script>

const voucherCardSerials = "voucher_card_serials";

function handleFiles(files) {
  // Check for the various File API support.
  if (window.FileReader) {
    // FileReader are supported.
    getAsText(files[0]);
  } else {
    alert('FileReader are not supported in this browser.');
  }
}

function getAsText(fileToRead) {
  var reader = new FileReader();
  // Handle errors load
  reader.onload = loadHandler;
  reader.onerror = errorHandler;
  // Read file into memory as UTF-8
  reader.readAsText(fileToRead);
}

function loadHandler(event) {
  var csv = event.target.result;
  processData(csv);
}

function processData(csv) {
    var allTextLines = csv.split(/\n/);
    var lines = [];
    var state = false;
    const PONumber = firebase.database().ref().child(voucherCardSerials).push().key;
    while (allTextLines.length) {
        lines.push(allTextLines.shift().split(':'));
    }

    for (var i = 0; i <= lines.length - 1; i++) {

      if (!state) {

        const begin = "Start_Sequence";

        if (lines[i][0] === begin) {
            console.log(lines[i][1]);
            state = true;
        }else{

          console.log("Header\n"+lines[i][0]+"\t"+lines[i][1]);
          firebase.database().ref().child(voucherCardSerials).child(PONumber).child(lines[i][0].trim()).set(lines[i][1].trim());
        }
      }else{
        if (lines[i][0] !=  "[END]" && lines[i][0] != "[BEGIN]") {

          if (lines[i][0] !="") {

            var vouchers = [];
            vouchers = lines[i][0].split(/ /);
            if( vouchers[1] != null){
                var serial = vouchers[0].trim();
                var pin = vouchers[1].trim()
                console.log("Serial\n"+serial);
                console.log("Pin\n"+pin);

                writeVoucherRealData(serial,pin,PONumber);
            }}
          }
      }
    }
  drawOutput(lines);
}

function writeVoucherRealData(serial,pin,po) {
    const voucherSequence = "voucher_sequence";
    firebase.database().ref(voucherCardSerials).child(po).child(voucherSequence).child(serial).set(pin);
}

function errorHandler(evt) {
  if(evt.target.error.name == "NotReadableError") {
    alert("Canno't read file !");
  }
}

function drawOutput(lines){
  //Clear previous data
  document.getElementById("output").innerHTML = "";
  var table = document.createElement("table");
  for (var i = 0; i < lines.length; i++) {
    var row = table.insertRow(-1);
    for (var j = 0; j < lines[i].length; j++) {
      var firstNameCell = row.insertCell(-1);
      firstNameCell.appendChild(document.createTextNode(lines[i][j]));
    }
  }
  document.getElementById("output").appendChild(table);
}

</script>

<!-- Start web template footer maintained by Zekarias Bogale -->

                </div>
            </div>
        </div>
    </div>
</div>

<footer class="text-center panel-footer">
Copyright Â© 2020 <a href="https://www.brootech.com">Brootech IT Solution</a>. All rights reserved.
</footer>

</body>
</html>

<!-- Start web template header maintained by Zekarias Bogale -->
